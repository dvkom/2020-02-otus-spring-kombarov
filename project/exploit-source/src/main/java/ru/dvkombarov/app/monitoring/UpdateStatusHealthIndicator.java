package ru.dvkombarov.app.monitoring;

import org.springframework.boot.actuate.health.Health;
import org.springframework.boot.actuate.health.HealthIndicator;
import org.springframework.stereotype.Component;
import ru.dvkombarov.app.constants.UpdateStatus;
import ru.dvkombarov.app.dao.repository.UpdateInfoRepository;
import ru.dvkombarov.app.domain.UpdateInfo;

import java.util.List;
import java.util.Map;

@Component
public class UpdateStatusHealthIndicator implements HealthIndicator {

    private static final String SUCCESS_COUNT = "Success updates count";
    private static final String ERROR_COUNT = "Error updates count";

    private final UpdateInfoRepository updateInfoRepository;

    public UpdateStatusHealthIndicator(UpdateInfoRepository updateInfoRepository) {
        this.updateInfoRepository = updateInfoRepository;
    }

    @Override
    public Health health() {
        try {
            List<UpdateInfo> updateInfoList = updateInfoRepository.findAll();

            long successCount = updateInfoList.stream()
                .map(UpdateInfo::getUpdateStatus)
                .filter(UpdateStatus.SUCCESS::equals)
                .count();

            long errorCount = updateInfoList.size() - successCount;

            Map<String, Long> details = Map.of(SUCCESS_COUNT, successCount, ERROR_COUNT, errorCount);
            if (errorCount < successCount) {
                return Health.up().withDetails(details).build();
            }

            return Health.down().withDetails(details).build();
        } catch (Exception e) {
            return Health.down(e).build();
        }
    }
}
